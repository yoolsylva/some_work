<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>APF Tool</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script>if (typeof module === 'object') {
    window.module = module;
    module = undefined;
  }</script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
          integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
          integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
          crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
          integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
          crossorigin="anonymous"></script>
  <link href="assets/css/login.css" rel="stylesheet">
  <link href="assets/css/button.css" rel="stylesheet">
  <link href="assets/css/loading.css" rel="stylesheet">
</head>
<body>
<div id="overlay">
  <div id="progstat"></div>
  <div id="progress"></div>
</div>
<div id="login-panel">
  <div>
    <img class="logo" src="assets/img/apf_tool_logo.png">
  </div>
  <div>
    <input class="login-btn grow" type="image" onclick="loginFB1()" src="assets/img/apf_tool_button_login.png">
  </div>
  <div class="footer">
    <p>Copyright © 2019 by KingContent.pro</p>
    <p>Made in Vietnam</p>
  </div>
</div>
<div id="main-panel" style="display: none">
  <div class="profile-container">
    <div class="profile-title">
      <input id="btn-close" type="image" src="assets/img/xbutton.png" onclick="closeApp()">
      <p>PROFILE</p>
    </div>
    <div class="profile-info">
      <div class="row">
        <div class="col-1"></div>
        <div class="col-4">
          <img class="profile-avatar" id="fb-avatar"
               src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSOuz-KqBeVSVh8wdcivMn3ikps08XGVbTvrHIMR-T6MWYa9Uhk">
        </div>
        <div class="col-6">
          <div class="row" style="margin-top: 30px">
            <p id="fb-name" style="-webkit-text-fill-color: aliceblue;">Nguyen Quyet Thang</p>
          </div>
          <div class="row">
            <p id="fb-uid" style="-webkit-text-fill-color: aliceblue;">UID: 132432532543</p>
          </div>
          <div class="row">
            <a class="btn success" id="btn-confirm" onclick="start()">Bắt đầu</a>
            <a class="btn success" id="btn-start" style="margin-left: 10px" onclick="logoutFB1()">Đăng xuất</a>
          </div>
        </div>
      </div>

    </div>
    <div class="history-bar">
      <div class="history-bar-column">
        <div>
          <h4>16</h4>
        </div>
        <div>
          <p>Lịch đã lên</p>
        </div>
      </div>
      <div class="history-bar-column">
        <div>
          <h4>22</h4>
        </div>
        <div>
          <p>Bộ sưu tập</p>
        </div>
      </div>
      <div class="history-bar-column">
        <div>
          <h4>322</h4>
        </div>
        <div>
          <p>Content đã lưu</p>
        </div>
      </div>
      <div class="history-bar-column">
        <div>
          <h4>66</h4>
        </div>
        <div>
          <p>Fanpage đã lưu</p>
        </div>
      </div>
    </div>
    <div>
      <ul class="nav nav-tabs nav-justified" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="schedule-post-tab" data-toggle="tab" href="#schedule-post" role="tab" aria-controls="home"
             aria-selected="true">Post</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="history-post-tab" data-toggle="tab" href="#history-post" role="tab" aria-controls="profile"
             aria-selected="false">History</a>
        </li>
      </ul>
      <div class="tab-content">
        <div class="loadbar-overlay" id="content-loadbar">
          <div class="loading">
            <div class="obj"></div>
            <div class="obj"></div>
            <div class="obj"></div>
            <div class="obj"></div>
            <div class="obj"></div>
            <div class="obj"></div>
            <div class="obj"></div>
            <div class="obj"></div>
          </div>
        </div>
        <div class="tab-pane fade show active" id="schedule-post" role="tabpanel" aria-labelledby="schedule-post-tab">
          <ul class="ul-post" id="pending-post">
          </ul>
        </div>
        <div class="tab-pane fade" id="history-post" role="tabpanel" aria-labelledby="history-post-tab">
          <ul class="ul-post" id="history-scheduled">
          </ul>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
    // You can also require other files to run in this process
    const puppeteer = require('puppeteer-core');
    const path = require('path');
    const fs = require('fs');
    const Store = require('electron-store');
    const store = new Store();
    const fetch = require('node-fetch');
    const request = require("request");
    const moment = require('moment');
    const rimraf = require('rimraf');
    const { ipcRenderer } = require('electron');

    let browserPath
    let browser1, browser2, browser3, browser4, browser5
    let page1, page2, page3, page4, page5
    let isRunning = false
    let isLogin = false
    let timeoutPendingPost = []
    let intervalUpdateTime = []

    var ovrl = id("overlay"),
      prog = id("progress"),
      stat = id("progstat"),
      c = 0,
      tot = 100;

    function id(v) {
      return document.getElementById(v);
    }

    async function doneLoading() {
      ovrl.style.opacity = 0;
      setTimeout(function () {
        ovrl.style.display = "none";
      }, 1200);
    }

    function progressLoaded() {
      c += 1;
      var perc = ((100 / tot * c) << 0) + "%";
      prog.style.width = perc;
      stat.innerHTML = "Loading " + perc;
    }

    async function loadbar(ms) {
      c = 0
      ovrl.style.display = "block"
      ovrl.style.opacity = 50
      for (var i = 0; i < tot; i++) {
        await sleep(ms)
        progressLoaded()
      }
    }

    function showLoadingData() {
      const loadbar_ovrl = document.getElementById('content-loadbar')
      loadbar_ovrl.style.opacity = 20
      loadbar_ovrl.style.display = "flex"
    }

    function hideLoadingData() {
      const loadbar_ovrl = document.getElementById('content-loadbar')
      loadbar_ovrl.style.opacity = 0
      loadbar_ovrl.style.display = "none"
    }

    function createFile(filename, data) {
      return new Promise((resolve, reject) => {
        fs.open(filename, 'r', function (err, fd) {
          if (err) {
            fs.writeFile(filename, data, function (err) {
              if (err) {
                console.log(err);
                return reject(err)
              }
              console.log("The file was saved!");
              resolve()
            });
          } else {
            console.log("The file exists!");
            resolve()
          }
        });
      })
    }

    async function checkLogin() {
      //await sleep(600)
      if (!store.get('slot1.name') || !store.get('slot1.id') || !store.get('slot1.picture') || !fs.existsSync(path.join(process.cwd(), 'facebook_account/slot1'))) {
        return false
      }
      return true
    }

    function clearInterval() {
      for (var i = 0; i < intervalUpdateTime.length; i++) {
        clearInterval(intervalUpdateTime[i]);
      }
      intervalUpdateTime = []
      for (var i = 0; i < timeoutPendingPost.length; i++) {
        clearTimeout(timeoutPendingPost[i]);
      }
      timeoutPendingPost = []
    }

    function closeApp() {
      clearInterval()
      const remote = require('electron').remote;
      var window = remote.getCurrentWindow();
      window.close();
    }

    //  This is main download function which takes the url of your image
    function download(uri, filename) {
      return new Promise((resolve, reject) => {
        request.head(uri, function (err, res, body) {
          if (err) return reject()
          request(uri)
            .pipe(fs.createWriteStream(path.join(process.cwd(), `/photo_upload/${filename}`)))
            .on("close", function () {
              resolve(path.join(process.cwd(), `/photo_upload/${filename}`))
            });
        });
      })
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function logoutFB1() {
      loadbar(10)
      clearInterval()
      await clearDataInfo()
      await sleep(2000)
      doneLoading()
      setLoginScreen()
    }

    async function loginFB1() {
      await clearDataInfo()

      const userDataDir = path.join(process.cwd(), `/facebook_account/slot1/`)
      browser1 = await puppeteer.launch({
        headless: false,
        slowMo: 50,
        userDataDir: userDataDir,
        executablePath: browserPath,
        args: [
          `--window-size=1000,800`
        ],
      });
      const pages = await browser1.pages();
      page1 = pages[0]
      await page1.setViewport({width: 1000, height: 800})
      /*const cookie = [
      {
        "name": "dbln",
        "value": "%7B%22100009096288948%22%3A%22cYFsUf6j%22%7D",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1586512161,
        "size": 48,
        "httpOnly": false,
        "secure": false,
        "session": false
      },
      {
        "name": "xs",
        "value": "6%3Ay8D7wKvWrAzFHQ%3A2%3A1554770951%3A11756%3A6156",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1586512161,
        "size": 48,
        "httpOnly": false,
        "secure": false,
        "session": false
      },
      {
        "name": "act",
        "value": "1554770952090%2F6",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1586512161,
        "size": 48,
        "httpOnly": false,
        "secure": false,
        "session": false
      },
      {
        "name": "spin",
        "value": "r.1000578944_b.trunk_t.1554770952_s.1_v.2_",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1586512161,
        "size": 48,
        "httpOnly": false,
        "secure": false,
        "session": false
      },
      {
        "name": "presence",
        "value": "EDvF3EtimeF1554770956EuserFA21B09096288948A2EstateFDutF1554770956352CEchFDp_5f1B09096288948F0CC",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1586512161,
        "size": 48,
        "httpOnly": false,
        "secure": false,
        "session": false
      },
      {
        "name": "sb",
        "value": "uOurXNT_FCc8ACeF6Cu7sPS4",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1617961756.328453,
        "size": 26,
        "httpOnly": true,
        "secure": true,
        "session": false
      },
      {
        "name": "",
        "value": "",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1586512329,
        "size": 0,
        "httpOnly": false,
        "secure": false,
        "session": false
      },
      {
        "name": "datr",
        "value": "G7ytXJHjYAIqdd4uMhT8EwvJ",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1617961760.12297,
        "size": 28,
        "httpOnly": true,
        "secure": true,
        "session": false
      },
      {
        "name": "wd",
        "value": "800x600",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1555496166,
        "size": 9,
        "httpOnly": false,
        "secure": true,
        "session": false
      },
      {
        "name": "fr",
        "value": "11EEp0EuKyXdf1YPm.AWUh0La7PM1VdzZjscD2h6cXXRU.Bcq-u4.Pv.Fyr.0.0.Bcq-wM.AWXulWFM",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1562667365.923576,
        "size": 81,
        "httpOnly": true,
        "secure": true,
        "session": false
      },
      {
        "name": "c_user",
        "value": "100009096288948",
        "domain": ".facebook.com",
        "path": "/",
        "expires": 1562667365.923576,
        "size": 81,
        "httpOnly": true,
        "secure": true,
        "session": false
      }
    ]
    await page1.setCookie(...cookie)*/
      await page1.goto('https://facebook.com', {waitUntil: 'domcontentloaded'});
      while (true) {
        await sleep(500)
        try {
          const result = await page1.evaluate(() => {
            var html = document.getElementsByTagName('html')[0].innerHTML
            var re = new RegExp('"USER_ID":"(.*?)"')
            var result = html.match(re);
            var profile_id = result && result[1]
            re = new RegExp('"NAME":"(.*?)"')
            result = html.match(re);
            var name = result && JSON.parse('"' + result[1] + '"')
            var img = document.querySelector("a[title='Profile'] > span > img") && document.querySelector("a[title='Profile'] > span > img").getAttribute('src')
            if (!profile_id || !name || !img) return null
            alert('Đăng nhập thành công! Bấm Ok để quay lại app!')
            return {profile_id, name, img}
          })

          if (!result) continue
          await browser1.close()
          const {profile_id, name, img} = result
          console.log(result)

          loadbar(100)
          const browser = await puppeteer.launch({
            headless: true,
            slowMo: 50,
            userDataDir: userDataDir,
            executablePath: browserPath,
            args: [
              `--window-size=1000,800`
            ],
          });
          const pages = await browser.pages();
          const page_tmp = pages[0]
          await page_tmp.setViewport({width: 1000, height: 800})
          await page_tmp.setCookie(...cookie)
          await page_tmp.goto(`https://facebook.com/${profile_id}`, {waitUntil: 'domcontentloaded'});
          await page_tmp.waitForSelector('.photoContainer')
          const img_bigger = await page_tmp.evaluate(() => {
            return document.querySelector('.photoContainer img').getAttribute('src')
          })
          await browser.close()
          console.log(img_bigger)
          doneLoading()
          setMainScreen()
          saveDataInfo({profile_id, name, img: img_bigger ? img_bigger : img})
          showDataInfo({profile_id, name, img: img_bigger ? img_bigger : img})
          break
        } catch (e) {
          console.error(e.message)
        }
      }
    };

    function setLoginScreen() {
      document.getElementById("main-panel").style.display = 'none'
      document.getElementById("login-panel").style.display = 'flex'
    }

    function setMainScreen() {
      document.getElementById("main-panel").style.display = 'block'
      document.getElementById("login-panel").style.display = 'none'
    }

    function clearDataInfo() {
      return new Promise((resolve, reject) => {
        store.delete(`slot1.id`)
        store.delete(`slot1.name`)
        store.delete(`slot1.picture`)
        store.delete(`slot1.history`)
        store.delete(`slot1.pendingpost`)
        const userDataDir = path.join(process.cwd(), `/facebook_account/slot1`)
        rimraf(userDataDir, function () {
          resolve()
        });
      })
    }

    function saveDataInfo({profile_id, name, img}) {
      store.set(`slot1.id`, profile_id)
      store.set(`${profile_id}`, 'slot1')
      store.set(`slot1.name`, name)
      store.set(`slot1.picture`, img)
    }

    function getDataInfo() {
      const profile_id = store.get('slot1.id')
      const name = store.get('slot1.name')
      const img = store.get('slot1.picture')
      return {profile_id, name, img}
    }

    function showDataInfo({profile_id, name, img}) {
      document.getElementById('fb-avatar').setAttribute('src', img)
      document.getElementById('fb-uid').innerText = profile_id
      document.getElementById('fb-name').innerText = name
    }

    function confirmDataInfo() {
      const profile_id = document.getElementById('fb-uid').innerText
      const name = document.getElementById('fb-name').innerText
      const img = document.getElementById('fb-avatar').getAttribute('src')
      saveDataInfo({profile_id, name, img})
      alert('Success')
    }

    async function postToUser({page, profile_id, resJson, imageFiles}) {
      page.on('dialog', async dialog => {
        console.log(dialog.message());
        await dialog.accept();
      });
      await page.setViewport({width: 800, height: 800})
      await page.goto('https://facebook.com?hl=en', {waitUntil: 'domcontentloaded'});
      await page.waitForSelector('div#pagelet_composer');
      await page.click('div#pagelet_composer');
      await page.waitForXPath('//div[@class="_1mf _1mj"] | //div[@data-testid="status-attachment-mentions-input"]')
      const status = await page.$x('//div[@class="_1mf _1mj"] | //div[@data-testid="status-attachment-mentions-input"]');
      await status[0].click()
      await page.keyboard.type(resJson.content, {delay: 0});
      const input = await page.$('input[type=file]')
      imageFiles.length && await input.uploadFile(...imageFiles)
      await sleep(1000)
      while (true) {
        const isDisable = await page.evaluate(() => {
          return document.querySelector("button[data-testid=react-composer-post-button]").disabled
        })
        if (!isDisable) break
        await sleep(50)
      }
      const share = await page.$('button[data-testid=react-composer-post-button]')
      await share.click()
      await sleep(4000)
      /*let i = 1000
    while(i--){
      await sleep(50)
      const post = await page.$x(`//div[@data-testid="newsFeedStream"]//a[contains(@href,"https://www.facebook.com/profile.php?id=${profile_id}")]/parent::div//div[@data-testid="story-subtitle"]/@id`)
      if(!post.length) continue
      const result = post[0].textContent.match(new RegExp('story_fbid=(.*?)&'))
      const postId = result && result[1]
      return postId
    }
    return null*/
    }

    async function postToPage({page, page_id, imageFiles, resJson}) {
      page.on('dialog', async dialog => {
        console.log(dialog.message());
        await dialog.accept();
      });
      const url = `https://facebook.com/${page_id}?hl=en`
      await page.setViewport({width: 800, height: 800})
      await page.goto(url, {waitUntil: 'domcontentloaded'});
      await page.waitForSelector('div[data-testid=status-attachment-mentions-input]')
      await page.click('div[data-testid=status-attachment-mentions-input]')
      await page.keyboard.type(resJson.content, {delay: 10});
      await page.click('div[data-testid=photo-video-button]')
      await page.waitForSelector("input[data-testid=media-attachment-add-photo]")
      const input = await page.$("input[data-testid=media-attachment-add-photo]")
      imageFiles.length && await input.uploadFile(...imageFiles)
      await sleep(1000)
      while (true) {
        const isDisable = await page.evaluate(() => {
          return document.querySelector("button[data-testid=react-composer-post-button]").disabled
        })
        if (!isDisable) break
        await sleep(50)
      }
      await page.click('button[data-testid=react-composer-post-button]')
      await sleep(8000)
      /*let i = 1000
    while(i--){
      await sleep(50)
      const post = await page.$x(`//a[contains(@href,"story_fbid=")]//span[contains(text(), "Just now")]/parent::abbr/parent::a/@href`)
      if(!post.length) continue
      const result = post[0].textContent.match(new RegExp('story_fbid=(.*?)&'))
      const postId = result && result[1]
      return postId
    }
    return null*/
    }

    async function postToGroup({page, group_id, imageFiles, resJson}) {
      page.on('dialog', async dialog => {
        console.log(dialog.message());
        await dialog.accept();
      });
      const url = `https://facebook.com/${group_id}?hl=en`
      await page.setViewport({width: 800, height: 800})
      await page.goto(url, {waitUntil: 'domcontentloaded'});
      await page.waitForXPath('//*[@data-testid="status-attachment-mentions-input"] | //*[@data-testid="react-composer-root"]//*[@data-testid="status-attachment-selector"]')
      const inputText = await page.$x('//*[@data-testid="status-attachment-mentions-input"]//div | //*[@data-testid="react-composer-root"]//*[@data-testid="status-attachment-selector"]')
      if (!inputText.length) throw new Error('Not found input text in group!')
      await inputText[0].click()
      await sleep(1000)
      try {
        await page.type('[data-testId="status-attachment-mentions-input"]', resJson.content)
      } catch (e) {
        await page.keyboard.type(resJson.content, {delay: 10});
      }
      const input = await page.$('input[data-testid=media-sprout]')
      imageFiles.length && await input.uploadFile(...imageFiles)
      await sleep(500)
      await page.waitForSelector('button[data-testid=react-composer-post-button]')
      while (true) {
        const isDisable = await page.evaluate(() => {
          return document.querySelector("button[data-testid=react-composer-post-button]").disabled
        })
        if (!isDisable) break
        await sleep(50)
      }
      await page.click('button[data-testid=react-composer-post-button]')
      await sleep(8000)
      /*let i = 1000
    while(i--){
      await sleep(50)
      const post = await page.$x(`//a[contains(@href,"groups/${group_id}/permalink/")]//span[contains(text(), "Just now")]/parent::abbr/parent::a/@href`)
      if(!post.length) continue
      const result = post[0].textContent.match(new RegExp('permalink/(.*)'))
      const postId = result && result[1]
      return postId
    }
    return null*/
    }

    function printLog(text) {
      ipcRenderer.send('message', text)
      fs.appendFile('error.txt', `${text}\n`, function (err) {
        if (err) throw err;
        console.log('Saved!');
      });
    }

    function clearLog() {
    }

    function getRandomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function appendPost({resJson, status, slotNumber}) {
      const isExist = document.getElementById(`${resJson.id}`)
      if (isExist) return
      const item = document.createElement('li')
      item.setAttribute('id', `${resJson.id}`)
      item.setAttribute('class', 'list-post')
      const img = document.createElement('img')
      img.setAttribute('class', 'post-thumpnail')
      img.setAttribute('src', resJson.images.length ? resJson.images[0] : 'assets/img/apf_tool_logo.png')
      const h5 = document.createElement('h5')
      h5.innerText = resJson.content
      const imgEye = document.createElement('img')
      imgEye.setAttribute('class', 'eye-icon')
      imgEye.setAttribute('src', 'assets/img/eye-icon.png')

      const now = moment(new Date()); //todays date
      const end = moment(resJson.date_publish); // another date
      const duration = moment.duration(end.diff(now)) > 0 ? moment.duration(end.diff(now)) : moment.duration(0);
      let totalTime = parseInt(duration.asSeconds())
      //let totalTime = getRandomBetween(20, 30)
      const {mnts, hrs, seconds} = convertSecondsToCountdown(totalTime)

      const p1 = document.createElement('p')
      p1.innerText = 'Ngày tạo: ' + moment(resJson.date_publish).format('DD/MM/YYYY')
      const p2 = document.createElement('p')
      p2.innerText = 'Tổng content đăng: ' + resJson.images.length
      const spanStatus = document.createElement('span')
      const imgStatus = document.createElement('img')
      imgStatus.setAttribute('src', `assets/img/${status}.png`)
      const pStatus = document.createElement('p')
      pStatus.innerText = status === 'wait' ? 'Đang chờ' : ''
      spanStatus.appendChild(imgStatus)
      spanStatus.appendChild(pStatus)

      item.appendChild(img)
      item.appendChild(h5)
      item.appendChild(p1)
      item.appendChild(imgEye)
      item.appendChild(p2)
      const countdount = document.createElement('p')
      countdount.innerText = `Đếm ngược: ${hrs}:${mnts}:${seconds}`
      item.appendChild(countdount)
      item.appendChild(spanStatus)

      document.getElementById('pending-post').appendChild(item)

      intervalUpdateTime.push(setInterval(() => {
        if (totalTime <= 0) {
          countdount.innerText = `Đếm ngược: 00:00:00`
          return
        }
        const {hrs, mnts, seconds} = convertSecondsToCountdown(--totalTime)
        countdount.innerText = `Đếm ngược: ${hrs}:${mnts}:${seconds}`
      }, 1000))

      timeoutPendingPost.push(setTimeout(async () => {
        console.log('wait running')
        await waitForRunningDone()
        console.log('posting now')
        imgStatus.setAttribute('src', `assets/img/play.png`)
        pStatus.innerText = 'Đang post...'
        let browser
        try {
          isRunning = true
          const profile_id = resJson.profile_id
          const imageFiles = await Promise.all(resJson.images.map((image, index) => {
            return download(image, `${index}.png`)
          }))
          const userDataDir = path.join(process.cwd(), `/facebook_account/${slotNumber}/`)
          browser = await puppeteer.launch({
            headless: false,
            slowMo: 50,
            userDataDir: userDataDir,
            executablePath: browserPath,
            args: [
              `--window-size=800,800`,
              //'--window-position=0,0'
            ],
          });
          const pages = await browser.pages();
          const page = pages[0]
          /*const cookie = [
          {
            "name": "dbln",
            "value": "%7B%22100009096288948%22%3A%22cYFsUf6j%22%7D",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1586512161,
            "size": 48,
            "httpOnly": false,
            "secure": false,
            "session": false
          },
          {
            "name": "xs",
            "value": "6%3Ay8D7wKvWrAzFHQ%3A2%3A1554770951%3A11756%3A6156",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1586512161,
            "size": 48,
            "httpOnly": false,
            "secure": false,
            "session": false
          },
          {
            "name": "act",
            "value": "1554770952090%2F6",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1586512161,
            "size": 48,
            "httpOnly": false,
            "secure": false,
            "session": false
          },
          {
            "name": "spin",
            "value": "r.1000578944_b.trunk_t.1554770952_s.1_v.2_",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1586512161,
            "size": 48,
            "httpOnly": false,
            "secure": false,
            "session": false
          },
          {
            "name": "presence",
            "value": "EDvF3EtimeF1554770956EuserFA21B09096288948A2EstateFDutF1554770956352CEchFDp_5f1B09096288948F0CC",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1586512161,
            "size": 48,
            "httpOnly": false,
            "secure": false,
            "session": false
          },
          {
            "name": "sb",
            "value": "uOurXNT_FCc8ACeF6Cu7sPS4",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1617961756.328453,
            "size": 26,
            "httpOnly": true,
            "secure": true,
            "session": false
          },
          {
            "name": "",
            "value": "",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1586512329,
            "size": 0,
            "httpOnly": false,
            "secure": false,
            "session": false
          },
          {
            "name": "datr",
            "value": "G7ytXJHjYAIqdd4uMhT8EwvJ",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1617961760.12297,
            "size": 28,
            "httpOnly": true,
            "secure": true,
            "session": false
          },
          {
            "name": "wd",
            "value": "800x600",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1555496166,
            "size": 9,
            "httpOnly": false,
            "secure": true,
            "session": false
          },
          {
            "name": "fr",
            "value": "11EEp0EuKyXdf1YPm.AWUh0La7PM1VdzZjscD2h6cXXRU.Bcq-u4.Pv.Fyr.0.0.Bcq-wM.AWXulWFM",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1562667365.923576,
            "size": 81,
            "httpOnly": true,
            "secure": true,
            "session": false
          },
          {
            "name": "c_user",
            "value": "100009096288948",
            "domain": ".facebook.com",
            "path": "/",
            "expires": 1562667365.923576,
            "size": 81,
            "httpOnly": true,
            "secure": true,
            "session": false
          }
        ]
        await page.setCookie(...cookie)*/

          const data = []
          let postPageTask, postGroupTask

          if (resJson.fanpage_ids.length) {
            await page.evaluate(() => window.open('https://www.google.com', 'page', 'height=800,width=800,top=0,left=700'));
            const newWindowTargetPage = await browser.waitForTarget(target => target.url() === 'https://www.google.com/');
            const newPage = await newWindowTargetPage.page()

            const postToAllPage = async () => {
              for (let i = 0; i < resJson.fanpage_ids.length; i++) {
                let status
                try {
                  await postToPage({page: newPage, page_id: resJson.fanpage_ids[i], imageFiles, resJson})
                  status = 'success'
                } catch (e) {
                  console.error(e.message)
                  status = 'fail'
                } finally {
                  data.push({id, status, fb_id: resJson.fanpage_ids[i]})
                }
              }
            }
            postPageTask = postToAllPage()
          }

          if (resJson.group_ids.length) {
            await page.evaluate(() => window.open('https://www.google.com.vn/', 'group', 'height=800,width=800,top=0,left=1100'));
            const newWindowTargetGroup = await browser.waitForTarget(target => target.url() === 'https://www.google.com.vn/');
            const newPageGroup = await newWindowTargetGroup.page()

            const postToAllGroup = async () => {
              for (let i = 0; i < resJson.group_ids.length; i++) {
                let status
                try {
                  const post_id = await postToGroup({
                    page: newPageGroup,
                    group_id: resJson.group_ids[i],
                    imageFiles,
                    resJson
                  })
                  status = 'success'
                  data.push({id, status, post_id})
                } catch (e) {
                  console.error(e.message)
                  status = 'fail'
                } finally {
                  data.push({id, status, fb_id: resJson.group_ids[i]})
                }
              }
            }
            postGroupTask = postToAllGroup()
          }
          const postUserTask = postToUser({page, profile_id, imageFiles, resJson})

          let statusUser
          try {
            await postUserTask
            statusUser = 'success'
          } catch (e) {
            console.error(e.message)
            statusUser = 'fail'
          } finally {
            data.push({id, status: statusUser, fb_id: profile_id})
          }

          if (resJson.fanpage_ids.length) await postPageTask
          if (resJson.group_ids.length) await postGroupTask

          await fetch('http://kingcontent.pro/api/response-data.php', {
            method: "POST", // *GET, POST, PUT, DELETE, etc.
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({key: 'OTJhMTJDMTRtcThTMTIwMkc1M3g', data})
          })
        } catch (e) {
          console.error(e.message)
          printLog(e.message)
        } finally {
          if (browser) await browser.close()
          isRunning = false
          updatePendingPost({resJson, type: 'remove', slotNumber})
        }
      }, Number(totalTime) * 1000))
    }

    function waitForRunningDone() {
      return new Promise(async resolve => {
        while (true) {
          await sleep(5000)
          if (!isRunning) resolve()
        }
      })
    }

    function convertSecondsToCountdown(seconds) {
      //var days = Math.floor(parseInt(seconds) / (3600*24));
      //seconds  -= days*3600*24;
      var hrs = Math.floor(seconds / 3600);
      seconds -= hrs * 3600;
      var mnts = Math.floor(seconds / 60);
      seconds -= mnts * 60;
      //days = days > 9? days : '0' + days
      hrs = hrs > 9 ? hrs : '0' + hrs
      mnts = mnts > 9 ? mnts : '0' + mnts
      seconds = seconds > 9 ? seconds : '0' + seconds
      return {hrs, mnts, seconds}
    }

    function clearPendingPost() {
      for (var i = 0; i < intervalUpdateTime.length; i++) {
        clearInterval(intervalUpdateTime[i]);
      }
      intervalUpdateTime = []
      for (var i = 0; i < timeoutPendingPost.length; i++) {
        clearTimeout(timeoutPendingPost[i]);
      }
      timeoutPendingPost = []
      var myNode = document.getElementById('pending-post')
      while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
      }
    }

    function updatePendingPost({resJson, type, slotNumber}) {
      let arrPendingPost = store.get(`${slotNumber}.pendingpost`) || []
      switch (type) {
        case 'add':
          arrPendingPost.push(resJson)
          arrPendingPost = arrPendingPost.sort((a, b) => {
            if (moment(a.date_publish) < moment(b.date_publish)) return 1
            else if (moment(a.date_publish) > moment(b.date_publish)) return -1
            return 0
          })
          clearPendingPost()
          store.set(`${slotNumber}.pendingpost`, arrPendingPost)
          for (let i = 0; i < arrPendingPost.length; i++) {
            appendPost({resJson: arrPendingPost[i], status: 'wait', slotNumber})
          }
          break;
        case 'remove':
          for (let i = arrPendingPost.length - 1; i >= 0; i--) {
            if (arrPendingPost[i].id === resJson.id) arrPendingPost.splice(i, 1);
          }
          store.set(`${slotNumber}.pendingpost`, arrPendingPost)
          const elementPost = document.getElementById(`${resJson.id}`)
          if (elementPost) elementPost.parentNode.removeChild(elementPost)
          break;
        default:
          for (let i = 0; i < arrPendingPost.length; i++) {
            appendPost({resJson: arrPendingPost[i], status: 'wait', slotNumber})
          }
      }
    }

    async function schedulePost() {
      showLoadingData()
      await sleep(3000)
      clearLog()
      printLog('Started!')
      const profile_id = store.get('slot1.id')
      if (!profile_id) {
        printLog('Information not saved')
        return
      }
      printLog('Loading data...')
      try {
        const res = await fetch(`http://kingcontent.pro/api/get-pending-data.php?key=OTJhMTJDMTRtcThTMTIwMkc1M3g&fb_id=${profile_id}`)
        const resJson = await res.json()
        if (resJson.error) throw new Error(resJson.message)
        printLog(`receive new data:`)
        printLog(resJson.data)
        resJson.data.forEach(data => {
          const id = data.id
          const slotNumber = store.get(data.profile_id)
          if (!slotNumber) {
            printLog(`Không tìm thấy account với profile_id: ${data.profile_id}`)
            fs.appendFile('error.txt', `Data:\n${JSON.stringify(resJson)}\nKhông tìm thấy account với profile_id: ${data.profile_id}\n\n\n`, function (err) {
              if (err) throw err;
              console.log('Saved!');
            });
          }
          updatePendingPost({resJson: data, type: 'add', slotNumber})
        })
      } catch (e) {
        console.error(e.message)
        printLog(e.message)
      }
      hideLoadingData()
    }

    async function scheduleHistory() {
      const profile_id = store.get('slot1.id')
      try {
        const res = await fetch(`http://kingcontent.pro/api/get-schedules.php?key=OTJhMTJDMTRtcThTMTIwMkc1M3g&fb_id=${profile_id}`)
        const resJson = await res.json()
        if (resJson.error) throw new Error(resJson.message)
        if (!resJson.data.length) return
        const slotNumber = store.get(resJson.data[0].contents.profile_id)
        if (!slotNumber) {
          printLog(`Không tìm thấy account với profile_id: ${data.profile_id}`)
          fs.appendFile('error.txt', `Data:\n${JSON.stringify(resJson)}\nKhông tìm thấy account với profile_id: ${resJson.data.profile_id}\n\n\n`, function (err) {
            if (err) throw err;
            console.log('Saved!');
          });
        }
        updateHistory({data: resJson.data, type: 'replace', slotNumber})
      } catch (e) {
        console.error(e.message)
        printLog(e.message)
      }
    }

    function clearHistory() {
      var myNode = document.getElementById('history-scheduled')
      while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
      }
    }

    function appendHistory({data}) {
      console.log(data)
      const item = document.createElement('li')
      item.setAttribute('class', 'list-post')
      const img = document.createElement('img')
      img.setAttribute('class', 'post-thumpnail')
      img.setAttribute('src', data.contents.images.length ? data.contents.images[0] : data.thumbnail)
      const h5 = document.createElement('h5')
      h5.innerText = data.name
      const imgEye = document.createElement('img')
      imgEye.setAttribute('class', 'eye-icon')
      imgEye.setAttribute('src', 'assets/img/eye-icon.png')

      const p1 = document.createElement('p')
      p1.innerText = 'Ngày tạo: ' + moment(data.created).format('DD/MM/YYYY')
      const p2 = document.createElement('p')
      p2.innerText = 'Tổng content đăng: ' + data.contents.images.length
      const spanStatus = document.createElement('span')
      const imgStatus = document.createElement('img')
      imgStatus.setAttribute('src', status ? `assets/img/done.png` : `assets/img/stop.png`)
      const pStatus = document.createElement('p')
      pStatus.innerText = status ? 'Hoàn tất' : 'Gặp Lỗi'
      spanStatus.appendChild(imgStatus)
      spanStatus.appendChild(pStatus)

      item.appendChild(img)
      item.appendChild(h5)
      item.appendChild(p1)
      item.appendChild(imgEye)
      item.appendChild(p2)
      const countdount = document.createElement('p')
      countdount.innerText = 'Ngày đăng: ' + data.contents.date_publish
      item.appendChild(countdount)
      item.appendChild(spanStatus)

      document.getElementById('history-scheduled').appendChild(item)
    }

    function updateHistory({data, type, slotNumber}) {
      let arrHistory = store.get(`${slotNumber}.history`) || []
      switch (type) {
        case 'add':
          arrHistory.unshift(data)
          clearHistory()
          store.set(`${slotNumber}.history`, arrHistory)
          for (let i = 0; i < arrHistory.length; i++) {
            appendHistory({data: arrHistory[i]})
          }
          break;
        case 'replace':
          clearHistory()
          store.set(`${slotNumber}.history`, data)
          for (let i = 0; i < data.length; i++) {
            appendHistory({data: data[i]})
          }
          break;
        default:
          for (let i = 0; i < arrHistory.length; i++) {
            appendHistory({data: arrHistory[i]})
          }
      }
    }

    function start() {
      schedulePost()
      setInterval(schedulePost, 60000 * 10)
      scheduleHistory()
      setInterval(scheduleHistory, 60000 * 60 * 2)
    }

    async function main() {
      loadbar(7)
      //store.set(`slot1.pendingpost`, null)
      createFile(path.join(process.cwd(), 'chrome-path.txt'), 'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe').then(() => {
        browserPath = fs.readFileSync(path.join(process.cwd(), 'chrome-path.txt')).toString()
      })
      !fs.existsSync(path.join(process.cwd(), 'photo_upload')) && fs.mkdirSync(path.join(process.cwd(), 'photo_upload'));
      !fs.existsSync(path.join(process.cwd(), 'facebook_account')) && fs.mkdirSync(path.join(process.cwd(), 'facebook_account'));
      isLogin = await checkLogin()
      doneLoading()
      if (!isLogin) setLoginScreen()
      else {
        setMainScreen()
        const {profile_id, name, img} = getDataInfo()
        showDataInfo({profile_id, name, img})
        updatePendingPost({slotNumber: 'slot1'})
        updateHistory({slotNumber: 'slot1'})
      }

      /* document.getElementById("fb-name").innerHTML = 'Name: ' + store.get('slot1.name') || null
     document.getElementById("fb-id").innerHTML = 'ID: ' + store.get('slot1.id') || null
     document.getElementById("fb-pp").src = store.get('slot1.picture') || "assets/img/default-profile-pic.jpg"
     txtlog_elm = document.getElementById("txtlog")
     buttonDone1 = document.getElementById("fb-button-login-done-1")*/
    }

    document.addEventListener('DOMContentLoaded', main, false);

</script>
</body>
</html>